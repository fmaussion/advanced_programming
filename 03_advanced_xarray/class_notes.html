
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced xarray &#8212; Advanced Scientific Programming</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet">
  <link href="../_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.d59cb220de22ca1c485ebbdc042f0030.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Assignments" href="assignments.html" />
    <link rel="prev" title="Assignments" href="../02_performance/assignments.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-88391345-1', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Advanced Scientific Programming</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../welcome.html">
   Welcome
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Introduction
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../syllabus.html">
   Syllabus
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference external" href="https://fabienmaussion.info/scientific_programming/faq.html">
   Frequently Asked Questions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../references.html">
   External resources
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../slides.html">
   Presentation slides
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Version control with git
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../01_git/class_notes.html">
   Version control with git
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../01_git/assignments.html">
   Assignments
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Performance
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../02_performance/class_notes.html">
   Advanced programming: performance
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../02_performance/assignments.html">
   Assignments
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Advanced xarray
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Advanced xarray
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="assignments.html">
   Assignments
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Design patterns
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../04_design/class_notes.html">
   Python “design patterns”
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/03_advanced_xarray/class_notes.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
                onclick="printPdf(this)" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/fmaussion/advanced_programming"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/fmaussion/advanced_programming/issues/new?title=Issue%20on%20page%20%2F03_advanced_xarray/class_notes.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/fmaussion/advanced_programming/edit/master/book/03_advanced_xarray/class_notes.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/fmaussion/advanced_programming/master?urlpath=lab/tree/book/03_advanced_xarray/class_notes.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show noprint">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dimension-vs-non-dimension-coordinates">
   Dimension vs non-dimension coordinates
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#map-projections-and-dimension-non-dimension-coordinates">
   Map projections and dimension / non-dimension coordinates
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#netcdf-to-memory">
   netcdf to memory
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#writing-to-netcdf-and-encoding">
   writing to netcdf and encoding
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dask">
   Dask
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Advanced xarray</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dimension-vs-non-dimension-coordinates">
   Dimension vs non-dimension coordinates
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#map-projections-and-dimension-non-dimension-coordinates">
   Map projections and dimension / non-dimension coordinates
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#netcdf-to-memory">
   netcdf to memory
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#writing-to-netcdf-and-encoding">
   writing to netcdf and encoding
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dask">
   Dask
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="advanced-xarray">
<h1>Advanced xarray<a class="headerlink" href="#advanced-xarray" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://hackmd.io/&#64;fmaussion/B17w40XS5">https://hackmd.io/&#64;fmaussion/B17w40XS5</a></p>
<div class="section" id="dimension-vs-non-dimension-coordinates">
<h2>Dimension vs non-dimension coordinates<a class="headerlink" href="#dimension-vs-non-dimension-coordinates" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://docs.xarray.dev/en/stable/user-guide/data-structures.html?highlight=coordinates#coordinates">link</a></p>
</div>
<div class="section" id="map-projections-and-dimension-non-dimension-coordinates">
<h2>Map projections and dimension / non-dimension coordinates<a class="headerlink" href="#map-projections-and-dimension-non-dimension-coordinates" title="Permalink to this headline">¶</a></h2>
<p><em>Specific for atmospheric science</em>: be careful about your map projections! You have to make a choice: is it useful for you to work with lat/lon? Or eastings/northings (constant grid spacing in kilometers)?
Because of the map projections, it could happen that once you select a box of certain lat/lon extent, you will end up with some NaN padding on the edges of your domain if your dimensions coordinates are specified as x/y. Note that you cant select a “box” if (lon, lat) are 2D coordinates. In this case you might use xarray <a class="reference external" href="https://xarray.pydata.org/en/v0.8.2/generated/xarray.Dataset.where.html">where</a> with <code class="docutils literal notranslate"><span class="pre">drop=True</span></code></p>
<p>For dealing with projections, check out <code class="docutils literal notranslate"><span class="pre">cartopy</span></code> (plotting) and <code class="docutils literal notranslate"><span class="pre">xESMF</span></code> (regridder for geospatial data, that can also deal with (x,y)-non-dimensional coordinates): <a class="reference external" href="https://xesmf.readthedocs.io">https://xesmf.readthedocs.io</a></p>
</div>
<div class="section" id="netcdf-to-memory">
<h2>netcdf to memory<a class="headerlink" href="#netcdf-to-memory" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>old-school way to check out the content of netcdf files without loading them: <code class="docutils literal notranslate"><span class="pre">ncdump</span></code> (<code class="docutils literal notranslate"><span class="pre">ncdump</span> <span class="pre">-h</span> <span class="pre">filename.nc</span></code>, where <code class="docutils literal notranslate"><span class="pre">h</span></code> stands for human-readable)</p></li>
<li><p><span class="xref myst">CF conventions</span>: conventions of metadata (the form they need to have)</p></li>
<li><p>Reading is a costly operation! Thus, when we first open a netcdf file, <code class="docutils literal notranslate"><span class="pre">xarray</span></code> parses only the necessary information (coords, dims), but the actual data is not loaded - it only says how many values the dataset contains (“lazy loading/evaluation” - this happen only at the moment when the values are needed)</p></li>
</ul>
</div>
<div class="section" id="writing-to-netcdf-and-encoding">
<h2>writing to netcdf and encoding<a class="headerlink" href="#writing-to-netcdf-and-encoding" title="Permalink to this headline">¶</a></h2>
<p><strong>Compression:</strong></p>
<ul class="simple">
<li><p>Files can be kept smaller (by a factor of 2) by using the “short” format for integers, i.e. 16 bits (16-bit floats are referred to as “half-precision”) instead of float 32-bit format, therefore 2 more attributes (a scale-factor and an offset are stored, which are used to ‘unpack’ the dataset whilst loading). This is <strong>lossy compression</strong> - precision is lost because of how the data is stored. The scale factor and offset are chosen so that this loss is minimal - still spanning the full range of data.</p></li>
<li><p><strong>lossless compression</strong>: <code class="docutils literal notranslate"><span class="pre">zip</span></code>/<code class="docutils literal notranslate"><span class="pre">gzip</span></code> - these use redundancy in the stored data. Netcfd is a “naive” data format - it doesn’t take into account redundancy - each value is stored individually, no matter how many times the data is repeated, whether all values are NaNs or unique floats. On the other hand, lossless compression uses these non-unique values  the more repeated values there are, the more compression we can get.</p>
<ul>
<li><p><strong>Advantages</strong>: less space on the disk</p></li>
<li><p><strong>Disdvantages</strong>: we can’t read just parts of the data (or do it way slower)</p></li>
</ul>
</li>
<li><p>lossy + lossless compression can be combined.</p></li>
</ul>
<p><a class="reference external" href="https://docs.xarray.dev/en/stable/user-guide/io.html#writing-encoded-data">Xarray docs on the subject</a></p>
</div>
<div class="section" id="dask">
<h2>Dask<a class="headerlink" href="#dask" title="Permalink to this headline">¶</a></h2>
<p>Big buzzword in the big-data community! (Big data = your memory does not fit the data you need to load).</p>
<p>By default, <code class="docutils literal notranslate"><span class="pre">xarray</span></code> does not use <code class="docutils literal notranslate"><span class="pre">dask</span></code>. Among other things which can make our lives easier, in the background <code class="docutils literal notranslate"><span class="pre">dask</span></code> uses multiprocessing.</p>
<p>Dask allows us to do operation on data which does not fit in the memory by:</p>
<ul class="simple">
<li><p>delaying evaluation to the latest possible moment</p></li>
<li><p>chunking the data (e.g. <code class="docutils literal notranslate"><span class="pre">ds</span> <span class="pre">=</span> <span class="pre">ds.chunk({'time':12})</span></code> divides the dataset into 12 chunks - individual slices - along the time dimension)</p></li>
</ul>
<p>When we request an operation on a dask array, it only knows what are all the steps necessary for the calculation (e.g. first add 2, then multiply by 3…). Once we e.g. plot the data, only then all the operations are evaluated.</p>
<ul class="simple">
<li><p>To check out the pipeline, we can easily visualize the graph: <code class="docutils literal notranslate"><span class="pre">chunked_ds.data.visualize('image.svg')</span></code>. This is useful for understanding what’s going on - what are all the steps of our computation.</p></li>
<li><p>if we use <code class="docutils literal notranslate"><span class="pre">xp.open_mfdataset()</span></code> (i.e. open multi-file dataset), dask is use automatically and the data is chunked by files.</p></li>
</ul>
<p>We will talk about the homework, and <a class="reference external" href="https://github.com/pydata/xarray/pull/6569/">this PR</a> and <a class="reference external" href="https://discourse.pangeo.io/t/dask-xarray-and-swap-memory-polution-on-local-linux-cluster/2453">this post</a></p>
<p>The place to be for big data analytics: <a class="reference external" href="https://pangeo.io">https://pangeo.io</a></p>
<p>The vision for the future of computing with large datasets: The idea of <strong>Pangeo</strong> is to <em>not</em> download large amounts of data, but to store the data only at one place (cloud) and providing access to people who wants to use it.
<strong>Copernicus data</strong>: <a class="reference external" href="https://cds.climate.copernicus.eu/toolbox/doc/index.html">CDS toolbox</a></p>
<p>We will then talk about xarray accessors: <a class="reference external" href="https://docs.xarray.dev/en/stable/internals/extending-xarray.html">https://docs.xarray.dev/en/stable/internals/extending-xarray.html</a></p>
<p>And this will be the introduction to decorators in python: <a class="reference external" href="https://realpython.com/primer-on-python-decorators">https://realpython.com/primer-on-python-decorators</a></p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./03_advanced_xarray"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            
                <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="../02_performance/assignments.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Assignments</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="assignments.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Assignments</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            
        </div>
    </div>
    <footer class="footer">
  <p>
    
      By Fabien Maussion<br/>
    
      <div class="extra_footer">
        <p>
<a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">
  <img align="right" class="margin" src="https://mirrors.creativecommons.org/presskit/buttons/88x31/svg/by.svg" width="88px">
</a>
These lecture notes and exercises are licensed under a <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">Creative Commons Attribution 4.0 International (CC BY 4.0) license</a>.
<br>
&copy; Copyright 2021-2022.
</p>

      </div>
  </p>
</footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>